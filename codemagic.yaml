workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      # groups:  # App Store Connect API key için (isteğe bağlı)
      #   - app_store_credentials
      vars:
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
        BUNDLE_ID: "com.esnaftaucuz.app"
        APP_ID: "com.esnaftaucuz.app"
      node: 18
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install dependencies
        script: |
          npm install
      - name: Build web
        script: |
          # Environment variables must be set in Codemagic UI (Settings → Environment variables)
          # VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY should be added as encrypted variables
          echo "Building with environment variables..."
          echo "VITE_SUPABASE_URL is set: $([ -n "$VITE_SUPABASE_URL" ] && echo 'YES' || echo 'NO')"
          echo "VITE_SUPABASE_ANON_KEY is set: $([ -n "$VITE_SUPABASE_ANON_KEY" ] && echo 'YES' || echo 'NO')"
          npm run build
      - name: Add iOS platform if not exists
        script: |
          if [ ! -d "ios" ]; then
            echo "iOS platform not found, adding..."
            npx cap add ios
          else
            echo "iOS platform already exists"
          fi
      - name: Install CocoaPods dependencies
        script: |
          cd ios/App
          pod install
          cd ../..
      - name: Sync Capacitor
        script: |
          npx cap sync ios
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Build iOS app
        script: |
          xcodebuild build \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath "$CM_BUILD_DIR/build"
      - name: Create IPA from build
        script: |
          echo "Creating IPA from build..."
          mkdir -p build/ios/ipa
          
          # Find the .app bundle
          APP_BUNDLE=$(find "$CM_BUILD_DIR/build" -name "App.app" -type d | head -1)
          
          if [ -z "$APP_BUNDLE" ]; then
            # Try alternative paths
            APP_BUNDLE=$(find "$CM_BUILD_DIR/build" -name "*.app" -type d | head -1)
          fi
          
          if [ -n "$APP_BUNDLE" ]; then
            echo "Found app bundle: $APP_BUNDLE"
            # Create IPA structure
            mkdir -p build/ios/ipa/Payload
            cp -R "$APP_BUNDLE" build/ios/ipa/Payload/
            
            # Create IPA file
            cd build/ios/ipa
            zip -r "$APP_ID.ipa" Payload
            cd ../../..
            
            echo "IPA created: build/ios/ipa/$APP_ID.ipa"
            ls -lh build/ios/ipa/
          else
            echo "App bundle not found. Searching in build directory..."
            find "$CM_BUILD_DIR/build" -type d -name "*.app" || echo "No .app bundles found"
            # Create empty structure for debugging
            mkdir -p build/ios/ipa
            echo "IPA creation failed - app bundle not found" > build/ios/ipa/error.txt
          fi
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/ipa/**/*
      - $CM_BUILD_DIR/build/**/*.app
      - $CM_BUILD_DIR/build/**/*.xcarchive
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: false
      scripts:
        - name: Print build info
          script: |
            echo "Build completed!"
            echo "Bundle ID: $BUNDLE_ID"
            echo "Workspace: $XCODE_WORKSPACE"
            echo "Scheme: $XCODE_SCHEME"

