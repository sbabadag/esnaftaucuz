workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - "2"  # Supabase environment variables grubu (VITE_SUPABASE_URL ve VITE_SUPABASE_ANON_KEY)
      vars:
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
        BUNDLE_ID: "com.esnaftaucuz.app"
        APP_ID: "com.esnaftaucuz.app"
      node: 18
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install dependencies
        script: |
          npm install
      - name: Build web
        script: |
          # Environment variables must be set in Codemagic UI (Settings â†’ Environment variables)
          # VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY should be added as encrypted variables
          echo "ðŸ” Checking environment variables..."
          echo "VITE_SUPABASE_URL is set: $([ -n "$VITE_SUPABASE_URL" ] && echo 'YES âœ…' || echo 'NO âŒ')"
          echo "VITE_SUPABASE_ANON_KEY is set: $([ -n "$VITE_SUPABASE_ANON_KEY" ] && echo 'YES âœ…' || echo 'NO âŒ')"
          
          # Check if environment variables are set
          if [ -z "$VITE_SUPABASE_URL" ] || [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
            echo "âŒ ERROR: Environment variables are missing!"
            echo "Please add VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in Codemagic Settings â†’ Environment variables"
            echo "Build will fail without these variables."
            exit 1
          fi
          
          # Export environment variables explicitly for npm build
          # Vite automatically reads VITE_* prefixed environment variables from process.env
          export VITE_SUPABASE_URL="$VITE_SUPABASE_URL"
          export VITE_SUPABASE_ANON_KEY="$VITE_SUPABASE_ANON_KEY"
          
          echo "âœ… Environment variables are set, starting build..."
          echo "VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:0:30}..."
          echo "VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY:0:20}..."
          
          # Verify environment variables are accessible
          echo "ðŸ” Verifying environment variables are accessible to Node.js..."
          node -e "console.log('VITE_SUPABASE_URL:', process.env.VITE_SUPABASE_URL ? 'SET âœ…' : 'MISSING âŒ'); console.log('VITE_SUPABASE_ANON_KEY:', process.env.VITE_SUPABASE_ANON_KEY ? 'SET âœ…' : 'MISSING âŒ');"
          
          # Create a temporary .env file for Vite to read during build
          # This ensures Vite can access the variables even if they're not in process.env
          echo "ðŸ“ Creating .env file for Vite..."
          echo "VITE_SUPABASE_URL=$VITE_SUPABASE_URL" > .env
          echo "VITE_SUPABASE_ANON_KEY=$VITE_SUPABASE_ANON_KEY" >> .env
          echo "âœ… .env file created"
          
          # Verify .env file contents (without exposing full values)
          echo "ðŸ” Verifying .env file..."
          echo "VITE_SUPABASE_URL in .env: $(grep -o 'VITE_SUPABASE_URL=.*' .env | cut -d'=' -f2 | cut -c1-30)..."
          echo "VITE_SUPABASE_ANON_KEY in .env: $(grep -o 'VITE_SUPABASE_ANON_KEY=.*' .env | cut -d'=' -f2 | cut -c1-20)..."
          
          # Build with environment variables - Vite will read from .env file
          npm run build
          
          # Clean up .env file after build (security)
          echo "ðŸ§¹ Cleaning up .env file..."
          rm -f .env
          
          # Verify build output contains correct URL
          echo "ðŸ” Verifying build output..."
          
          # Check if the real Supabase URL is in the build output
          if grep -r "xmskjcdwmwlcmjexnnxw" dist/ 2>/dev/null | head -1; then
            echo "âœ… Correct Supabase URL found in build output!"
            echo "âœ… Build verification passed - real Supabase URL is present"
            
            # Check if placeholder is ONLY in fallback code (which is OK)
            # The placeholder might appear in the fallback code path, but as long as
            # the real URL is also present, the app will use the real URL
            PLACEHOLDER_COUNT=$(grep -r "placeholder.supabase.co" dist/ 2>/dev/null | wc -l | tr -d ' ')
            if [ "$PLACEHOLDER_COUNT" -gt 0 ]; then
              echo "â„¹ï¸  Note: Placeholder URL found in build (likely in fallback code path)"
              echo "â„¹ï¸  This is OK as long as the real Supabase URL is also present"
              echo "âœ… Build is valid - real URL will be used at runtime"
            fi
          else
            echo "âŒ ERROR: Real Supabase URL not found in build output!"
            echo "This means environment variables were not properly injected."
            echo "Checking for placeholder URL..."
            if grep -r "placeholder.supabase.co" dist/ 2>/dev/null | head -1; then
              echo "âŒ Only placeholder URL found - build will fail at runtime"
            else
              echo "âŒ No Supabase URLs found in build output"
            fi
            exit 1
          fi
      - name: Add iOS platform if not exists
        script: |
          if [ ! -d "ios" ]; then
            echo "iOS platform not found, adding..."
            npx cap add ios
          else
            echo "iOS platform already exists"
          fi
      - name: Install CocoaPods dependencies
        script: |
          cd ios/App
          pod install
          cd ../..
      - name: Sync Capacitor
        script: |
          npx cap sync ios
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Build iOS app
        script: |
          xcodebuild build \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath "$CM_BUILD_DIR/build"
      - name: Create IPA from build
        script: |
          echo "Creating IPA from build..."
          mkdir -p build/ios/ipa
          
          # Find the .app bundle
          APP_BUNDLE=$(find "$CM_BUILD_DIR/build" -name "App.app" -type d | head -1)
          
          if [ -z "$APP_BUNDLE" ]; then
            # Try alternative paths
            APP_BUNDLE=$(find "$CM_BUILD_DIR/build" -name "*.app" -type d | head -1)
          fi
          
          if [ -n "$APP_BUNDLE" ]; then
            echo "Found app bundle: $APP_BUNDLE"
            # Create IPA structure
            mkdir -p build/ios/ipa/Payload
            cp -R "$APP_BUNDLE" build/ios/ipa/Payload/
            
            # Create IPA file
            cd build/ios/ipa
            zip -r "$APP_ID.ipa" Payload
            cd ../../..
            
            echo "IPA created: build/ios/ipa/$APP_ID.ipa"
            ls -lh build/ios/ipa/
          else
            echo "App bundle not found. Searching in build directory..."
            find "$CM_BUILD_DIR/build" -type d -name "*.app" || echo "No .app bundles found"
            # Create empty structure for debugging
            mkdir -p build/ios/ipa
            echo "IPA creation failed - app bundle not found" > build/ios/ipa/error.txt
          fi
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/ipa/**/*
      - $CM_BUILD_DIR/build/**/*.app
      - $CM_BUILD_DIR/build/**/*.xcarchive
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: false
      scripts:
        - name: Print build info
          script: |
            echo "Build completed!"
            echo "Bundle ID: $BUNDLE_ID"
            echo "Workspace: $XCODE_WORKSPACE"
            echo "Scheme: $XCODE_SCHEME"

